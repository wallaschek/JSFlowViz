<html>
<head>

<script type='text/javascript'>
window.onload=function(){
	/*
    d3.json("/wm/jsflowviz/json/switches.do",update_switches);
	d3.json("/wm/jsflowviz/json/links.do",update_links);
    */
    d3.json("switches.do.json",update_switches);
	d3.json("links.do.json",update_links);
}

var links;
var switches = {};

function update_layout() {
    var force = d3.layout.force()
                .size([600, 600])
                //.charge(-400)
                .nodes(switches)
                .links(links)
                .on("tick",function(d) { sync_circles() });
    force.start();
}

function sync_circles() {
    var svg = d3.select("#graph")
	svg.selectAll("circle").data(aarray_to_list(this.switches),function(d){return d.dpid})
   									.attr("cx",  function(d,i) {return d.x})
   									.attr("cy", function(d,i) {return d.y})
}
function Switch(dpid) {
    this.dpid = dpid;
    this.x = dpid*30;
    this.y = dpid*30;
    this.px = dpid*30;
    this.py = dpid*30;
    this.fixed = false;
    this.weight = 2;

}

function update_switches(switches) {
    for (key in switches) {
        this.switches[String(switches[key])] = new Switch(switches[key])
    }
	var svg = d3.select("#graph")
	svg.selectAll("circle").data(aarray_to_list(this.switches),function(d){return d.dpid}).enter()
   								.append("svg:circle")
   									.attr("r", 10)
   									.attr("cx",  function(d,i) {return d.x})
   									.attr("cy", function(d,i) {return d.y})
                                    .attr("dpid", function(d,i) {return d.dpid});
    var x = 1;
}
function get_path(l) {
    return "M"+l.source.x+","+l.source.y+"L"+l.target.x+","+l.target.y;
}

function Link(source,target) {
	this.source = source;
	this.target = target;
}


function aarray_to_list(aarray) {
    l = [];
    for (key in aarray) {
        l.push(aarray[key]);
    }
    return l;
}

function update_links(links) {
    this.links = translate_links(links);
	var svg = d3.select("#graph");
	var circles = svg.selectAll("circle");
	svg.selectAll(".link").data(this.links,function(d){return String(d.source.dpid)+String(d.target.dpid)}).enter()
			.append("path")
			.attr("class","link")
			.attr("d",function(d){return get_path(d)});
    update_layout();
}

function translate_links(links) {
    nlinks=[]
    for (var key in links) {
        var source = switches[String(links[key].source)];
        var target = switches[String(links[key].target)];
        nlinks.push(new Link(source,target))
    }
    return nlinks
}

</script>
</head>
<body>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<svg id="graph" style="width:100%, height:100%"></svg>
</body>
</html>
